<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Alert Vial - Mapa Inteligente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; width: 100%; }

    /* --- PANEL FLOTANTE LATERAL --- */
    .control-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 360px;
      max-height: 90vh;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 20px;
      background: #2c3e50;
      color: white;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-header h3 { margin: 0; font-size: 1.1rem; }
    .panel-body { padding: 20px; }

    /* Pesta√±as */
    .tabs { display: flex; background: #ecf0f1; padding: 5px; border-radius: 8px; margin-bottom: 20px; }
    .tab-btn {
      flex: 1; border: none; padding: 10px; background: transparent;
      cursor: pointer; border-radius: 6px; font-weight: 600; color: #7f8c8d;
      transition: 0.3s;
    }
    .tab-btn.active { background: #fff; color: #e74c3c; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }

    /* Formularios */
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #34495e; }
    
    .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
    
    input, select {
      width: 100%; padding: 10px;
      border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box;
    }
    input:focus { border-color: #e74c3c; outline: none; }

    /* Botones */
    .btn-action {
      width: 100%; padding: 12px; border: none; border-radius: 6px;
      font-weight: bold; font-size: 1rem; cursor: pointer; color: white;
      transition: transform 0.1s; margin-bottom: 5px;
    }
    .btn-action:active { transform: scale(0.98); }
    .btn-rutas { background: #27ae60; }
    .btn-riesgo { background: #e67e22; }
    
    .btn-icon {
      padding: 0 12px; border: 1px solid #bdc3c7; background: #f8f9fa;
      border-radius: 6px; cursor: pointer; font-size: 1.2rem;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-icon:hover { background: #e2e6ea; }

    .btn-clear {
      background: #95a5a6; color: white; font-size: 0.9rem; padding: 8px; margin-top: 5px;
    }

    /* Resultados */
    .result-card {
      margin-top: 15px; padding: 15px; border-radius: 8px; background: #f8f9fa;
      border-left: 5px solid #ccc; font-size: 0.9rem;
      position: relative;
    }
    .res-low { border-left-color: #2ecc71; background: #eafaf1; }
    .res-med { border-left-color: #f1c40f; background: #fef9e7; }
    .res-high { border-left-color: #e74c3c; background: #fdedec; }

    /* InfoWindow Custom */
    .gm-style-iw { padding: 0 !important; overflow: hidden !important; }
    .acc-info-window { min-width: 220px; }
    .acc-info-header { background: #c0392b; color: white; padding: 10px; font-weight: bold; font-size: 0.95rem; }
    .acc-info-body { padding: 12px; }
    .acc-info-body p { margin: 6px 0; font-size: 13px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 4px; }
    .btn-details {
      background: #2980b9; color: white; border: none; padding: 8px;
      border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; margin-top: 8px; font-weight: bold;
    }
    .btn-details:hover { background: #3498db; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="control-panel">
    <div class="panel-header">
      <h3>üöî Alert Vial: An√°lisis</h3>
      <a href="/alertv" style="color:white; text-decoration:none; font-size:0.8rem; border:1px solid white; padding:4px 8px; border-radius:4px;">‚¨Ö Volver</a>
    </div>
    
    <div class="panel-body">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('heatmap')">üî• Mapa & Riesgo</button>
        <button class="tab-btn" onclick="switchTab('rutas')">üìç Rutas Seguras</button>
      </div>

      <div id="tab-heatmap" class="tab-content active">
        <p style="font-size: 0.85rem; color: #7f8c8d; margin-top:0;">
          <strong>Modo Interactivo:</strong><br>
          ‚Ä¢ Clic en <span style="color:red">‚óè</span>: Ver detalle accidente.<br>
          ‚Ä¢ Clic en mapa: Analizar riesgo de zona.
        </p>
        
        <label>Filtros R√°pidos:</label>
        <select id="filtro-gravedad" onchange="recargarMapa()">
          <option value="">Todas las gravedades</option>
          <option value="Con heridos">Con Heridos</option>
          <option value="Con muertos">Con Muertos</option>
          <option value="Solo da√±os">Solo Da√±os</option>
        </select>
        
        <div id="riesgo-resultado" class="result-card" style="display:none;">
          <button onclick="limpiarAnalisis()" style="position:absolute; top:5px; right:5px; border:none; background:transparent; font-size:16px; cursor:pointer; color:#999;">&times;</button>
          <strong>üìç An√°lisis de Zona:</strong><br>
          <div id="riesgo-texto" style="margin-top:5px;">Calculando...</div>
        </div>
      </div>

      <div id="tab-rutas" class="tab-content">
        <label>Origen:</label>
        <div class="input-group">
          <input type="text" id="origen" placeholder="Ej: Parque Boyac√°...">
          <button class="btn-icon" onclick="usarUbicacionActual()" title="Usar mi ubicaci√≥n actual">üìç</button>
        </div>
        
        <label>Destino:</label>
        <div class="input-group">
           <input type="text" id="destino" placeholder="Clic en mapa o escribe...">
        </div>
        
        <button class="btn-action btn-rutas" onclick="calcularRutaSegura()">Buscar Ruta Segura</button>
        <button class="btn-action btn-clear" onclick="limpiarRutaCompleta()">üóëÔ∏è Limpiar Ruta</button>
        
        <div id="ruta-resultado" class="result-card" style="display:none;">
          </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGuzlSWeHrkxHu1PjR_DVRTjkNkQxd2gg&libraries=visualization,places,geometry"></script>

  <script>
    let map, heatmap, directionsService, directionsRenderer, geocoder;
    let clickMarkers = []; // C√≠rculos accidentes
    let analysisMarker = null; // Marcador riesgo
    let destMarker = null; // Marcador destino (clic mapa)
    let infoWindow = null; 

    function initMap() {
      // 1. Mapa Base (SIN estilo que oculte POIs)
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: { lat: 4.08466, lng: -76.1969 }, // Tulu√°
        mapTypeId: 'roadmap',
        // HE QUITADO EL ARRAY DE STYLES PARA QUE SE VEAN LOS LUGARES
        clickableIcons: true // Permite clic en los POIs de Google
      });

      // 2. Servicios
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        polylineOptions: { strokeColor: '#27ae60', strokeWeight: 6, strokeOpacity: 0.8 },
        suppressMarkers: false // Usaremos los marcadores por defecto A y B
      });
      geocoder = new google.maps.Geocoder();

      // 3. Autocomplete Inputs
      setupAutocomplete('origen');
      setupAutocomplete('destino');

      // 4. Cargar Heatmap
      cargarDatosHeatmap();

      // 5. LISTENER GLOBAL INTELIGENTE
      map.addListener('click', (e) => {
        // Verificar qu√© pesta√±a est√° activa
        if(document.getElementById('tab-heatmap').classList.contains('active')) {
          // MODO RIESGO: Analizar punto
          analizarRiesgoPunto(e.latLng);
        } else {
          // MODO RUTAS: Seleccionar destino
          seleccionarDestinoClick(e.latLng);
        }
      });
    }

    function setupAutocomplete(id) {
        const input = document.getElementById(id);
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);
    }

    // --- CARGAR DATOS HEATMAP ---
    async function cargarDatosHeatmap() {
      if(heatmap) heatmap.setMap(null);
      clickMarkers.forEach(m => m.setMap(null));
      clickMarkers = [];

      try {
        const res = await fetch('/api/accidentes_all');
        const data = await res.json();
        const heatData = [];

        data.accidentes.forEach(acc => {
          const latLng = new google.maps.LatLng(acc.lat, acc.lng);
          heatData.push(latLng);

          // C√≠rculo invisible para clic
          const circle = new google.maps.Circle({
            strokeOpacity: 0, fillOpacity: 0,
            map: map, center: latLng, radius: 20, zIndex: 999, clickable: true
          });

          google.maps.event.addListener(circle, 'click', (ev) => {
            if (ev.stop) ev.stop(); // Prioridad al accidente
            mostrarInfoAccidente(acc, latLng);
          });
          
          clickMarkers.push(circle);
        });

        heatmap = new google.maps.visualization.HeatmapLayer({
          data: heatData, map: map, radius: 30, opacity: 0.6
        });

      } catch (err) { console.error(err); }
    }

    // --- MOSTRAR INFO ACCIDENTE ---
    function mostrarInfoAccidente(acc, pos) {
      if (infoWindow) infoWindow.close();
      const html = `
        <div class="acc-info-window">
          <div class="acc-info-header">‚ö†Ô∏è Reporte #${acc.id}</div>
          <div class="acc-info-body">
            <p><strong>üìÖ Fecha:</strong> ${acc.fecha.split('T')[0]}</p>
            <p><strong>üöó Tipo:</strong> ${acc.clase_accidente}</p>
            <p><strong>ü§ï Gravedad:</strong> ${acc.gravedad}</p>
            <button class="btn-details" onclick="verFotoDetalle(${acc.id})">üì∏ Ver Foto</button>
          </div>
        </div>
      `;
      infoWindow = new google.maps.InfoWindow({ content: html, position: pos });
      infoWindow.open(map);
    }

    function verFotoDetalle(id) {
      fetch(`/api/accidente/${id}`)
        .then(r => r.json())
        .then(d => {
          let fotoHtml = d.fotos && d.fotos.length > 0 
            ? `<img src="/static/img/${d.fotos[0]}" style="width:100%; border-radius:8px; max-height:250px; object-fit:cover;">` 
            : `<div style="padding:20px; background:#f0f0f0; text-align:center;">üö´ Sin foto</div>`;

          Swal.fire({
            title: `Detalle Incidente`,
            html: `${fotoHtml}<div style="text-align:left; margin-top:10px;">
              <strong>Veh√≠culo:</strong> ${d.clase_vehiculo}<br>
              <strong>Direcci√≥n:</strong> ${d.direccion}<br>
              <strong>Nota:</strong> ${d.nota_interna || '-'}
            </div>`,
            width: 450
          });
        });
    }

    // --- AN√ÅLISIS DE RIESGO PUNTUAL ---
    async function analizarRiesgoPunto(latLng) {
      if (analysisMarker) analysisMarker.setMap(null);
      const box = document.getElementById('riesgo-resultado');
      const txt = document.getElementById('riesgo-texto');
      
      box.style.display = 'block';
      txt.innerHTML = 'üîÑ Analizando...';
      box.className = 'result-card'; 

      analysisMarker = new google.maps.Marker({
        position: latLng, map: map, animation: google.maps.Animation.DROP,
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#3498db", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
      });

      try {
        const resp = await fetch('/api/riesgo/calcular', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ lat: latLng.lat(), lng: latLng.lng(), filtros: {radio: 100} })
        });
        const data = await resp.json();
        const pct = (data.nivel_riesgo * 100).toFixed(0);
        let clase = pct < 20 ? 'res-low' : (pct < 50 ? 'res-med' : 'res-high');
        let txtRiesgo = pct < 20 ? 'Bajo' : (pct < 50 ? 'Moderado' : 'Alto üö®');
        
        box.className = `result-card ${clase}`;
        txt.innerHTML = `<strong>Riesgo: ${txtRiesgo} (${pct}%)</strong><br>Accidentes (100m): <strong>${data.accidentes_cercanos}</strong>`;
      } catch(e) { txt.innerHTML = 'Error.'; }
    }

    function limpiarAnalisis() {
      if (analysisMarker) analysisMarker.setMap(null);
      document.getElementById('riesgo-resultado').style.display = 'none';
    }

    // --- L√ìGICA DE RUTAS ---
    
    // --- GEOLOCALIZACI√ìN H√çBRIDA (A prueba de Linux/Brave) ---
    function usarUbicacionActual() {
      const inputOrigen = document.getElementById('origen');

      if (!navigator.geolocation) {
        return Swal.fire('Error', 'Tu navegador no soporta geolocalizaci√≥n.', 'error');
      }

      inputOrigen.value = "üìç Buscando tu ubicaci√≥n...";

      // Funci√≥n de √©xito (com√∫n para ambos intentos)
      const exito = (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const latLng = { lat, lng };

        console.log("Ubicaci√≥n encontrada:", latLng, "Precisi√≥n:", pos.coords.accuracy, "metros");

        map.setCenter(latLng);
        map.setZoom(16);

        // Intentar obtener direcci√≥n escrita
        geocoder.geocode({ location: latLng }, (results, status) => {
          if (status === "OK" && results[0]) {
            inputOrigen.value = results[0].formatted_address;
          } else {
            // Si falla el nombre, dejamos las coordenadas
            inputOrigen.value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          }
        });
      };

      // Funci√≥n de error final
      const errorFinal = (err) => {
        console.warn("Fallo total de ubicaci√≥n:", err);
        inputOrigen.value = "";
        
        let msg = "No pudimos encontrarte.";
        if(err.code === 1) msg = "‚ö†Ô∏è Permiso denegado. Revisa el candado üîí en la barra de direcciones.";
        
        Swal.fire('Ubicaci√≥n no disponible', msg, 'warning');
      };


      navigator.geolocation.getCurrentPosition(
        exito, 
        (err) => {
            console.log("Fallo alta precisi√≥n, intentando baja precisi√≥n...");
            
            // INTENTO 2: BAJA PRECISI√ìN (IP / Antenas)
            // Esto es lo que te funcionaba antes (te pone en el centro de Tulu√°)
            navigator.geolocation.getCurrentPosition(
                exito,
                errorFinal,
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
            );
        }, 
        { enableHighAccuracy: true, timeout: 3000 } 
      );
    }

    // 2. Seleccionar Destino con Clic
    function seleccionarDestinoClick(latLng) {
      if (destMarker) destMarker.setMap(null);
      
      // Llenar input temporalmente
      document.getElementById('destino').value = "Cargando direcci√≥n...";
      
      destMarker = new google.maps.Marker({
        position: latLng, map: map,
        title: "Destino seleccionado"
      });

      geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === "OK" && results[0]) {
          document.getElementById('destino').value = results[0].formatted_address;
        } else {
          document.getElementById('destino').value = `${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}`;
        }
      });
    }

    // 3. Calcular
    function calcularRutaSegura() {
      const origen = document.getElementById('origen').value;
      const destino = document.getElementById('destino').value;
      const resBox = document.getElementById('ruta-resultado');
      
      if(!origen || !destino) return Swal.fire('Faltan Datos', 'Ingresa origen y destino', 'warning');

      resBox.style.display = 'block';
      resBox.innerHTML = 'üîÑ Calculando...';
      resBox.className = 'result-card'; 

      // Limpiar ruta anterior visualmente
      if(destMarker) destMarker.setMap(null); // Quitar pin manual si existe
      directionsRenderer.setMap(map); 

      directionsService.route({
        origin: origen,
        destination: destino,
        travelMode: 'DRIVING',
        provideRouteAlternatives: true
      }, async (result, status) => {
        if (status === 'OK') {
          const ruta = result.routes[0];
          directionsRenderer.setDirections(result);

          // An√°lisis de riesgo de la ruta
          const puntos = sampleRoute(ruta.overview_path, 10);
          let riesgoAcumulado = 0;
          let accTotal = 0;

          for(let p of puntos) {
            try {
              const resp = await fetch('/api/riesgo/calcular', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ lat: p.lat(), lng: p.lng(), filtros: {radio: 100} })
              });
              const data = await resp.json();
              riesgoAcumulado += data.nivel_riesgo;
              accTotal += data.accidentes_cercanos;
            } catch(e) {}
          }

          const prom = (riesgoAcumulado / puntos.length) * 100;
          let color = prom < 20 ? 'res-low' : (prom < 50 ? 'res-med' : 'res-high');
          let txt = prom < 20 ? 'Bajo' : (prom < 50 ? 'Medio' : 'Alto');

          resBox.className = `result-card ${color}`;
          resBox.innerHTML = `
            <strong>üèÅ Ruta Lista:</strong> ${ruta.legs[0].distance.text} (${ruta.legs[0].duration.text})<br>
            <strong>üõ°Ô∏è Riesgo: ${txt} (${prom.toFixed(0)}%)</strong><br>
            Accidentes detectados en trayecto: ${accTotal}
          `;
        } else {
          resBox.innerHTML = '‚ùå Ruta no encontrada.';
        }
      });
    }

    // 4. Limpiar Todo
    function limpiarRutaCompleta() {
      document.getElementById('origen').value = "";
      document.getElementById('destino').value = "";
      document.getElementById('ruta-resultado').style.display = 'none';
      
      directionsRenderer.setMap(null); // Borra l√≠nea azul
      if(destMarker) destMarker.setMap(null); // Borra pin destino
      
      // Reinicializar renderer para futura ruta
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        polylineOptions: { strokeColor: '#27ae60', strokeWeight: 6, strokeOpacity: 0.8 }
      });
    }

    function sampleRoute(path, count) {
      if (!path || path.length === 0) return [];
      const step = Math.ceil(path.length / count);
      const s = [];
      for (let i = 0; i < path.length; i += step) s.push(path[i]);
      return s;
    }

    // --- UTILS ---
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      event.target.classList.add('active');
      
      limpiarAnalisis();
      // No borramos la ruta al cambiar de tab para que el usuario pueda comparar, 
      // pero si quieres borrarla descomenta:
      // limpiarRutaCompleta(); 
    }
    
    function recargarMapa() { cargarDatosHeatmap(); }

    window.onload = initMap;
  </script>
</body>
</html>