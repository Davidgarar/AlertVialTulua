<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Accidentes y An√°lisis de Riesgo</title>
  <style>
    #map { 
      height: 100vh; 
      width: 100%; 
      margin:0; 
      padding:0; 
    }
    body, html { 
      height:100%; 
      margin:0; 
      font-family: Arial, sans-serif;
    }
    
    /* Panel de control de riesgo */
    .risk-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 300px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .risk-controls h3 {
      margin: 0 0 15px 0;
      color: #dc3545;
      text-align: center;
    }
    
    .filter-group {
      margin: 10px 0;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .filter-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: white;
    }
    
    .btn-analyze {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
      transition: background 0.3s ease;
    }
    
    .btn-analyze:hover {
      background: #c82333;
    }
    
    .risk-results {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      display: none;
    }
    
    .risk-level {
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin: 10px 0;
    }
    
    .risk-low { 
      background: #d4edda; 
      color: #155724; 
      border: 2px solid #c3e6cb;
    }
    
    .risk-medium { 
      background: #fff3cd; 
      color: #856404; 
      border: 2px solid #ffeaa7;
    }
    
    .risk-high { 
      background: #f8d7da; 
      color: #721c24; 
      border: 2px solid #f5c6cb;
    }
    
    .risk-details {
      font-size: 14px;
      line-height: 1.4;
    }
    
    .coordinates-info {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      margin: 10px 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panel de control de riesgo -->
  <div class="risk-controls">
    <h3>üö® An√°lisis de Riesgo</h3>
    
    <div class="coordinates-info">
      <strong>Haz clic en el mapa para analizar riesgo</strong>
    </div>
    
    <div class="filter-group">
      <label>Horario:</label>
      <select id="filter-hora">
        <option value="">Todo el d√≠a</option>
        <option value="06:00-09:00">Ma√±ana (6:00-9:00)</option>
        <option value="16:00-19:00">Tarde (16:00-19:00)</option>
        <option value="20:00-06:00">Noche (20:00-6:00)</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Gravedad:</label>
      <select id="filter-gravedad">
        <option value="">Todas</option>
        <option value="Con heridos">Con heridos</option>
        <option value="Con muertos">Con muertos</option>
        <option value="Solo da√±os">Solo da√±os</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>A√±o:</label>
      <select id="filter-ano">
        <option value="">Todos los a√±os</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
        <option value="2022">2022</option>
      </select>
    </div>
    
    <button onclick="calcularRiesgo()" class="btn-analyze">Calcular Riesgo en Punto</button>
    
    <!-- Resultados del riesgo -->
    <div id="risk-results" class="risk-results">
      <h4>Resultados del An√°lisis</h4>
      <div id="risk-level" class="risk-level">
        <!-- Aqu√≠ se mostrar√° el nivel de riesgo -->
      </div>
      <div id="risk-details" class="risk-details">
        <!-- Detalles del an√°lisis -->
      </div>
    </div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGuzlSWeHrkxHu1PjR_DVRTjkNkQxd2gg&libraries=visualization"></script>

  <script>
    // Variables globales
    let map;
    let heatmap;
    let currentCoords = { lat: 4.085, lng: -76.195 };
    let clickMarker = null;

    function initMap(dataPoints) {
      const center = { lat: 4.085, lng: -76.195 };
      map = new google.maps.Map(document.getElementById('map'), { 
        zoom: 13, 
        center, 
        mapTypeId: 'roadmap' 
      });
      
      // Crear heatmap con los datos de accidentes
      const heatData = dataPoints.map(p => new google.maps.LatLng(p[0], p[1]));
      heatmap = new google.maps.visualization.HeatmapLayer({ 
        data: heatData, 
        radius: 30, 
        opacity: 0.6 
      });
      heatmap.setMap(map);
      
      // Agregar listener para clics en el mapa
      map.addListener('click', function(event) {
        handleMapClick(event.latLng);
      });
      
      console.log('Mapa inicializado. Haz clic en cualquier punto para analizar riesgo.');
    }

    // Manejar clic en el mapa
    function handleMapClick(latLng) {
      currentCoords = {
        lat: latLng.lat(),
        lng: latLng.lng()
      };
      
      // Actualizar info de coordenadas
      document.querySelector('.coordinates-info').innerHTML = `
        <strong>Coordenadas seleccionadas:</strong><br>
        Lat: ${currentCoords.lat.toFixed(6)}<br>
        Lng: ${currentCoords.lng.toFixed(6)}
      `;
      
      // Agregar o mover marcador
      if (!clickMarker) {
        clickMarker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: 'Punto de an√°lisis',
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="16" r="12" fill="#dc3545" stroke="white" stroke-width="2"/>
                <text x="16" y="21" text-anchor="middle" fill="white" font-size="14">!</text>
              </svg>
            `),
            scaledSize: new google.maps.Size(32, 32)
          }
        });
      } else {
        clickMarker.setPosition(latLng);
      }
      
      console.log('Coordenadas seleccionadas:', currentCoords);
    }

    // Funci√≥n para calcular riesgo
    async function calcularRiesgo() {
      if (!currentCoords) {
        alert('Por favor, haz clic en el mapa primero para seleccionar una ubicaci√≥n.');
        return;
      }

      // Mostrar loading
      const riskLevel = document.getElementById('risk-level');
      const riskDetails = document.getElementById('risk-details');
      const riskResults = document.getElementById('risk-results');
      
      riskLevel.innerHTML = 'üîÑ Calculando riesgo...';
      riskDetails.innerHTML = '';
      riskResults.style.display = 'block';

      // Obtener filtros
      const filtros = {
        hora: document.getElementById('filter-hora').value,
        gravedad: document.getElementById('filter-gravedad').value,
        ano: document.getElementById('filter-ano').value
      };

      try {
        const response = await fetch('/api/riesgo/calcular', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            lat: currentCoords.lat,
            lng: currentCoords.lng,
            filtros: construirFiltros(filtros)
          })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Mostrar resultados
        mostrarResultadosRiesgo(data);

      } catch (error) {
        console.error('Error al calcular riesgo:', error);
        riskLevel.innerHTML = '‚ùå Error al calcular riesgo';
        riskDetails.innerHTML = `No se pudo calcular el riesgo: ${error.message}`;
        riskLevel.className = 'risk-level risk-medium';
      }
    }

    // Funci√≥n para construir objeto de filtros
    function construirFiltros(filtros) {
      const filtrosObj = {};
      
      if (filtros.hora) {
        const [inicio, fin] = filtros.hora.split('-');
        filtrosObj.hora = [inicio, fin];
      }
      
      if (filtros.gravedad) {
        filtrosObj.gravedad = [filtros.gravedad];
      }
      
      if (filtros.ano) {
        filtrosObj.ano = [filtros.ano];
      }
      
      return filtrosObj;
    }

    // Funci√≥n para mostrar resultados del riesgo
    function mostrarResultadosRiesgo(data) {
      const riskLevel = document.getElementById('risk-level');
      const riskDetails = document.getElementById('risk-details');
      
      const nivelRiesgo = data.nivel_riesgo;
      const porcentaje = (nivelRiesgo * 100).toFixed(1);
      
      // Determinar nivel de riesgo y color
      let nivelTexto, nivelClase, recomendacion;
      
      if (nivelRiesgo < 0.3) {
        nivelTexto = 'BAJO';
        nivelClase = 'risk-low';
        recomendacion = 'Zona relativamente segura. Mantenga las precauciones b√°sicas.';
      } else if (nivelRiesgo < 0.7) {
        nivelTexto = 'MEDIO';
        nivelClase = 'risk-medium';
        recomendacion = 'Zona con riesgo moderado. Extreme precauciones al conducir.';
      } else {
        nivelTexto = 'ALTO';
        nivelClase = 'risk-high';
        recomendacion = 'Zona de alto riesgo. Evite si es posible, extreme todas las precauciones.';
      }
      
      // Mostrar nivel de riesgo
      riskLevel.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 10px;">${porcentaje}%</div>
        <div>Nivel de Riesgo: ${nivelTexto}</div>
      `;
      riskLevel.className = `risk-level ${nivelClase}`;
      
      // Mostrar detalles
      riskDetails.innerHTML = `
        <strong>üìç Ubicaci√≥n analizada:</strong><br>
        Lat: ${data.lat.toFixed(6)}, Lng: ${data.lng.toFixed(6)}<br><br>
        
        <strong>üìä Resultado:</strong><br>
        Nivel de riesgo calculado: ${porcentaje}%<br><br>
        
        <strong>üö® Recomendaci√≥n:</strong><br>
        ${recomendacion}<br><br>
        
        <strong>‚öôÔ∏è Filtros aplicados:</strong><br>
        ${Object.keys(data.filtros_aplicados).length > 0 ? 
          JSON.stringify(data.filtros_aplicados, null, 2) : 
          'Ning√∫n filtro aplicado'}
      `;
    }

    // Cargar datos de accidentes y inicializar mapa
    fetch('/api/accidentes')
      .then(res => res.json())
      .then(data => initMap(data))
      .catch(err => { 
        console.error('Error cargando accidentes:', err); 
        initMap([]); 
      });
  </script>
</body>
</html>